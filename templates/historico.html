{% extends "base.html" %}

{% block conteudo %}

<h1>Histórico de Vendas</h1>

<p>
  Usuário: <b>{{ usuario }}</b> ({{ tipo }})
</p>

<!-- FILTRO POR DATA -->
<form method="get" action="/historico">
    <label>
        Data inicial:
        <input type="date" name="data_inicio" value="{{ data_inicio }}">
    </label>

    <label>
        Data final:
        <input type="date" name="data_fim" value="{{ data_fim }}">
    </label>

    <button type="submit">Filtrar</button>
    <a href="/historico" class="button">Limpar</a>
</form>

<br>

<!-- RESUMO: TOTAL DO DIA / MÊS -->
<p>
  <b>Total do dia:</b>
  <span style="color:green; font-weight:bold;">R$ {{ total_dia }}</span>
  <br>
  <b>Total do mês:</b>
  <span style="color:green; font-weight:bold;">R$ {{ total_mes }}</span>
</p>

<a class="button" href="/registrar">Registrar Nova Venda</a>
<a class="button" href="/resumo_mes">Resumo do mês</a>

<!-- Baixar CSV com os mesmos filtros aplicados -->
<a class="button" href="/download?data_inicio={{ data_inicio }}&data_fim={{ data_fim }}">Baixar CSV</a>

<a class="button" href="/logout">Sair</a>

<br><br>

{% if vendas %}
<table>
    <tr>
        <th>Data</th>
        <th>Hora</th>
        <th>Cliente</th>
        <th>Barbeiro</th>
        <th>Cabelo</th>
        <th>Barba</th>
        <th>Sobrancelha</th>
        <th>Produto</th>
        <th>Pagamento</th>
        <th>Desconto</th>
        <th>Total</th>
        {% if tipo == "admin" %}
          <th>Ações</th>
        {% endif %}
    </tr>

    {% for v in vendas %}
    <tr>
        <td>{{ v.data }}</td>
        <td>{{ v.hora }}</td>
        <td>{{ v.cliente }}</td>
        <td>{{ v.barbeiro }}</td>
        <td>R$ {{ v.cabelo }}</td>
        <td>R$ {{ v.barba }}</td>
        <td>R$ {{ v.sobrancelha }}</td>

        <!-- ✅ Produto correto: nome + valor -->
        <td>
            {% if v.produto_nome %}
              {{ v.produto_nome }} (R$ {{ v.produto_valor }})
            {% else %}
              —
            {% endif %}
        </td>

        <td>{{ v.pagamento }}</td>

        <td style="color:red; font-weight:bold;">- R$ {{ v.desconto }}</td>
        <td style="color:green; font-weight:bold;">R$ {{ v.total }}</td>

        {% if tipo == "admin" %}
        <td>
          <form method="post"
                action="/venda/{{ v.id }}/excluir?data_inicio={{ data_inicio }}&data_fim={{ data_fim }}"
                onsubmit="return confirm('Tem certeza que deseja excluir esta venda?');"
                style="display:inline;">
            <button type="submit">Excluir</button>
          </form>
        </td>
        {% endif %}
    </tr>
    {% endfor %}
</table>
{% else %}
<p>Nenhuma venda encontrada.</p>
{% endif %}

{% endblock %}
